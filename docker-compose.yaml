version: '3.8'

services:
  # --- Databases ---
  book-db:
    image: mysql:8.0
    container_name: book-db
    environment:
      MYSQL_DATABASE: book_db
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_USER: ${DB_USERNAME}
      MYSQL_PASSWORD: ${DB_PASSWORD}
    volumes:
      - book_db_data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin" ,"ping", "-h", "localhost"]
      timeout: 20s
      retries: 10

  member-db:
    image: mysql:8.0
    container_name: member-db
    environment:
      MYSQL_DATABASE: member_db
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_USER: ${DB_USERNAME}
      MYSQL_PASSWORD: ${DB_PASSWORD}
    volumes:
      - member_db_data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin" ,"ping", "-h", "localhost"]
      timeout: 20s
      retries: 10

  borrowing-db:
    image: mysql:8.0
    container_name: borrowing-db
    environment:
      MYSQL_DATABASE: borrowing_db
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_USER: ${DB_USERNAME}
      MYSQL_PASSWORD: ${DB_PASSWORD}
    volumes:
      - borrowing_db_data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin" ,"ping", "-h", "localhost"]
      timeout: 20s
      retries: 10

  # --- Cache ---
  redis:
    image: redis:latest
    container_name: library-redis
    ports:
      - "6379:6379"

  # --- Microservices ---
  book-service:
    build: ./book-service
    image: yigitsert/library-book-service:latest
    container_name: book-service
    depends_on:
      book-db:
        condition: service_healthy
      redis:
        condition: service_started
    ports:
      - "8081:8081"
    environment:
      - DB_HOST=book-db
      - DB_USERNAME=${DB_USERNAME}
      - DB_PASSWORD=${DB_PASSWORD}
      - REDIS_HOST=redis

  member-service:
    build: ./member-service
    image: yigitsert/library-member-service:latest
    container_name: member-service
    depends_on:
      member-db:
        condition: service_healthy
      redis:
        condition: service_started
    ports:
      - "8082:8082"
    environment:
      - DB_HOST=member-db
      - DB_USERNAME=${DB_USERNAME}
      - DB_PASSWORD=${DB_PASSWORD}
      - REDIS_HOST=redis
      - SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
      - SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_GOOGLE_REDIRECT_URI=${APP_BASE_URL:-http://localhost}/login/oauth2/code/google

  borrowing-service:
    build: ./borrowing-service
    image: yigitsert/library-borrowing-service:latest
    container_name: borrowing-service
    depends_on:
      borrowing-db:
        condition: service_healthy
      redis:
        condition: service_started
    ports:
      - "8083:8083"
    environment:
      - DB_HOST=borrowing-db
      - DB_USERNAME=${DB_USERNAME}
      - DB_PASSWORD=${DB_PASSWORD}
      - REDIS_HOST=redis
      - SERVICES_BOOK_URL=${SERVICES_BOOK_URL:-http://book-service:8081/api/books}
      - SERVICES_MEMBER_URL=${SERVICES_MEMBER_URL:-http://member-service:8082/api/members}

  # --- API Gateway ---
  nginx:
    build: ./nginx
    image: yigitsert/library-nginx:latest
    container_name: library-nginx
    ports:
      - "80:80"
    depends_on:
      - book-service
      - member-service
      - borrowing-service

volumes:
  book_db_data:
  member_db_data:
  borrowing_db_data: